{
	"AWSTemplateFormatVersion" : "2010-09-09",
	"Description" : "This nested stack will create the environment for the project infrastructure in an isolated VPC.",
	"Parameters" : {
		"tagCostCenter":{
      "Type": "String",
      "Description":"tag - cost center"
    },
    "tagEnvironment":{
      "Type": "String",
      "Description":"tag - environment",
      "AllowedValues" : ["sb", "test", "dev", "mergeddev", "qa", "prod"]
    },
    "tagGroup":{
      "Type": "String",
      "Description":"tag - group name"
    },
    "tagKeepAlive":{
      "Type": "String",
      "Description":"tag - keep alive tag",
      "AllowedValues" : ["true", "false"]
    },
    "tagOwner":{
      "Type": "String",
      "Description":"tag - product owner"
    },
    "tagProject":{
      "Type": "String",
      "Description":"tag - project name"
    },
    "tagStack":{
	    "Type": "String",
	    "Description":"tag - stack name"
	  },
		"bucketCfTemplates":{
			"Type":"String",
			"Description": "The name of the S3 bucket that holds the cloudformation templates used in nested stacks"
		},
		"iamRoleNameAppServer": {
			"Type": "String",
			"Description": "name of the iam role for the app server"
		},
		"iamRoleNameCrossStackLookup": {
			"Type": "String",
			"Description": "name of the iam role that enables references of resources in another cloudformation stack"
		},
		"instanceTypeAppServer":{
  		"Description" : "ec2 instance type for the app server",
  		"Type" : "String"
  	},
		"keyName": {
	  	"Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances",
	  	"Type": "String",
	  	"ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
		},
		"preliminariesStackName":{
      "Type": "String",
			"Description": "The name of the preliminaries cloudformation stack"
	  },
		"privateSubnetCidr":{
     	"Description" : "The CIDR block of the primary private subnet.",
   		"Type": "String"
  	},
		"publicSubnetCidr":{
  		"Description" : "The CIDR block of the inbound public subnet.",
   		"Type": "String"
  	},
		"bucketResources":{
    	"Type":"String",
    	"Description": "The name of the S3 bucket that holds resource files for conductor"
    },
		"sshSourceIp":{
			"Type":"String",
    	"Description": "ip address to allow ssh access from"
		},
		"vpcCidr":{
			"Description" : "The CIDR block of the VPC",
			"Type" : "String"
  	},		
		"doNotCreate" : {
	    "Description" : "If doNotCreateStack condition is present (\"Condition\" : \"doNotCreateStack\") in resource definition, then the resource is not created",
	    "Default" : "true",
	    "Type" : "String"
		}
  },

	"Conditions" : {
    "doNotCreateStack" : {"Fn::Equals" : [{"Ref" : "doNotCreate"}, "false"]}
  },

	"Resources" : {
		"baseNetwork": {
			"Type":"AWS::CloudFormation::Stack",
			"Metadata": {
				"Comment":"Creates the network entities for the environment."
			},
			"Properties" :{
				"Parameters" :{
					"tagCostCenter": {"Ref" : "tagCostCenter"},
          "tagEnvironment": {"Ref" : "tagEnvironment"},
          "tagGroup": {"Ref" : "tagGroup"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
          "tagProject": {"Ref" : "tagProject"},
          "tagStack": {"Ref" : "tagStack"},
					"vpcCidr": {"Ref" : "vpcCidr"}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/base-network.json"]]}
			}
		},

		"baseSecurity": {
			"Type":"AWS::CloudFormation::Stack",
			"Properties" :{
				"Parameters" :{
					"tagCostCenter": {"Ref" : "tagCostCenter"},
          "tagEnvironment": {"Ref" : "tagEnvironment"},
          "tagGroup": {"Ref" : "tagGroup"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
          "tagProject": {"Ref" : "tagProject"},
          "tagStack": {"Ref" : "tagStack"},
					"bucketCfTemplates": {"Ref": "bucketCfTemplates"},
					"vpcCidr": {"Ref" : "vpcCidr"},
					"publicSubnetCidr": {"Ref" : "publicSubnetCidr"},
					"privateSubnetCidr": {"Ref" : "privateSubnetCidr"},
					"sshSourceIp":{"Ref":"sshSourceIp"},
					"internetGatewayId": { "Fn::GetAtt" : [ "baseNetwork", "Outputs.internetGatewayId" ] },
					"vpcId": { "Fn::GetAtt" : [ "baseNetwork", "Outputs.vpcId" ] }
		    },
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/base-security.json"]]}
			},
			"DependsOn" : "baseNetwork"
		},

		"crossStackInfoPreliminariesStack": {
		  "Type": "Custom::CrossStackInfoSNSArn",
		  "Properties": {
		    "ServiceToken": { "Fn::GetAtt" : ["lambdaSetup", "Outputs.lambdaArnCrossStackLookup"] },
=======
    "doNotCreateStack" : {"Fn::Equals" : [{"Ref" : "doNotCreate"}, "false"]},
		"createVpcStack" : {"Fn::Or": [{"Fn::Equals" : [{"Ref" : "tagEnvironment"}, "prod"]}, {"Fn::Equals" : [{"Ref" : "tagEnvironment"}, "dev"]}]}
  },

	"Resources" : {
		"vpcLookupCrossStackOutputs": {
		  "Type": "AWS::Lambda::Function",
			"Condition" : "createVpcStack",
		  "Properties": {
				"FunctionName" : {"Fn::Join":["-",[{"Ref": "tagEnvironment"}, {"Ref": "tagProject"}, "vpcLookupCrossStackOutputs"]]},
		    "Code": {
		      "ZipFile":  { "Fn::Join": ["\n", [
		        "var response = require('cfn-response');",
		        "exports.handler = function(event, context) {",
		        "    console.log('REQUEST RECEIVED:\\n', JSON.stringify(event));",
		        "    if (event.RequestType == 'Delete') {",
		        "        response.send(event, context, response.SUCCESS);",
		        "        return;",
		        "    }",
		        "    var stackName = event.ResourceProperties.StackName;",
		        "    var responseData = {};",
		        "    if (stackName) {",
		        "        var aws = require('aws-sdk');",
		        "        var cfn = new aws.CloudFormation();",
		        "        cfn.describeStacks({StackName: stackName}, function(err, data) {",
		        "            if (err) {",
		        "                responseData = {Error: 'DescribeStacks call failed'};",
		        "                console.log(responseData.Error + ':\\n', err);",
		        "                response.send(event, context, response.FAILED, responseData);",
		        "            }",
		        "            else {",
		        "                data.Stacks[0].Outputs.forEach(function(output) {",
		        "                    responseData[output.OutputKey] = output.OutputValue;",
		        "                });",
		        "                response.send(event, context, response.SUCCESS, responseData);",
		        "            }",
		        "        });",
		        "    } else {",
		        "        responseData = {Error: 'Stack name not specified'};",
		        "        console.log(responseData.Error);",
		        "        response.send(event, context, response.FAILED, responseData);",
		        "    }",
		        "};"
		      ]]}
		    },
		    "Handler": "index.handler",
		    "Runtime": "nodejs",
		    "Timeout": "30",
		    "Role": { "Fn::GetAtt" : ["vpcLookupCrossStackOutputsRole", "Arn"] }
		  },
			"DependsOn": "vpcLookupCrossStackOutputsRole"
		},

		"vpcLookupCrossStackOutputsRole": {
		  "Type": "AWS::IAM::Role",
			"Condition" : "createVpcStack",
		  "Properties": {
		    "AssumeRolePolicyDocument": {
		      "Version": "2012-10-17",
		      "Statement": [{
		        "Effect": "Allow",
		        "Principal": {"Service": ["lambda.amazonaws.com"]},
		        "Action": ["sts:AssumeRole"]
		      }]
		    },
		    "Path": "/",
		    "Policies": [{
		      "PolicyName" : {"Fn::Join":["-",[{"Ref": "tagEnvironment"}, {"Ref": "tagProject"}, "vpcLookupCrossStackOutputs"]]},
		      "PolicyDocument": {
		        "Version": "2012-10-17",
		        "Statement": [{
		          "Effect": "Allow",
		          "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
		          "Resource": "arn:aws:logs:*:*:*"
		        },
		        {
		          "Effect": "Allow",
		          "Action": ["cloudformation:DescribeStacks"],
		          "Resource": "*"
		        }]
		      }
		    }]
		  }
		},

		"crossStackInfoPreliminariesStack": {
		  "Type": "Custom::crossStackInfoPreliminariesStack",
			"Condition" : "createVpcStack",
		  "Properties": {
		    "ServiceToken": { "Fn::GetAtt" : ["vpcLookupCrossStackOutputs", "Arn"] },
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
		    "tagStack": {
		      "Ref": "preliminariesStackName"
		    }
		  },
<<<<<<< HEAD
			"DependsOn": "lambdaSetup"
		},

		"iamSetup":{
			"Type":"AWS::CloudFormation::Stack",
=======
			"DependsOn": "vpcLookupCrossStackOutputs"
		},

		"baseNetwork": {
			"Type":"AWS::CloudFormation::Stack",
			"Condition" : "createVpcStack",
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
			"Properties" :{
				"Parameters" :{
					"tagStack": {"Ref" : "tagStack"},
					"tagProject": {"Ref" : "tagProject"},
					"tagGroup": {"Ref" : "tagGroup"},
<<<<<<< HEAD
					"tagCostCenter": {"Ref" : "tagCostCenter"},
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"bucketResources": {"Ref" : "bucketResources"},
					"iamRoleNameAppServer": {"Ref" : "iamRoleNameAppServer"},
					"iamRoleNameCrossStackLookup": {"Ref" : "iamRoleNameCrossStackLookup"},
					"iamRoleNameDbServer": {"Ref" : "iamRoleNameDbServer"},
					"iamRoleNameFileServer": {"Ref" : "iamRoleNameFileServer"},
					"iamRoleNameRdGateway": {"Ref" : "iamRoleNameRdGateway"}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/iam-setup.json"]]}
			}
		},

		"lambdaSetup": {
			"Type":"AWS::CloudFormation::Stack",
=======
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"vpcCidr": {"Ref" : "vpcCidr"}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/basenetwork.json"]]}
			}
		},

		"baseSecurity": {
			"Type":"AWS::CloudFormation::Stack",
			"Condition" : "createVpcStack",
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
			"Properties" :{
				"Parameters" :{
					"tagStack": {"Ref" : "tagStack"},
					"tagProject": {"Ref" : "tagProject"},
					"tagGroup": {"Ref" : "tagGroup"},
<<<<<<< HEAD
					"tagCostCenter": {"Ref" : "tagCostCenter"},
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"iamRoleArnCrossStackLookup": { "Fn::GetAtt" : [ "iamSetup", "Outputs.iamRoleArnCrossStackLookup" ] },
					"functionNameCrossStackLookup": {"Fn::Join":["-",[{"Ref": "tagEnvironment"}, {"Ref": "tagProject"}, "crossStackLookup"]]}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/lambda-functions.json"]]}
			},
			"DependsOn": ["iamSetup"]
=======
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"bucketCfTemplates": {"Ref" : "bucketCfTemplates"},
					"vpcCidr": {"Ref" : "vpcCidr"},
					"publicSubnetCIDR": {"Ref" : "publicSubnetCIDR"},
					"privateSubnetCIDR": {"Ref" : "privateSubnetCIDR"},
					"internetGatewayId": { "Fn::GetAtt" : [ "baseNetwork", "Outputs.internetGatewayId" ] },
					"vpcId": { "Fn::GetAtt" : [ "baseNetwork", "Outputs.vpcId" ] }
		    },
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/basesecurity.json"]]}
			},
			"DependsOn" : "baseNetwork"
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
		},

		"securityGroups":{
			"Type":"AWS::CloudFormation::Stack",
<<<<<<< HEAD
=======
			"Condition" : "createVpcStack",
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
			"Properties" :{
				"Parameters" :{
					"tagStack": {"Ref" : "tagStack"},
					"tagProject": {"Ref" : "tagProject"},
					"tagGroup": {"Ref" : "tagGroup"},
<<<<<<< HEAD
					"tagCostCenter": {"Ref" : "tagCostCenter"},
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"bucketCfTemplates": {"Ref": "bucketCfTemplates"},
					"vpcId": { "Fn::GetAtt" : [ "baseNetwork", "Outputs.vpcId" ] },
					"sshSourceIp":{"Ref":"sshSourceIp"}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/security-groups.json"]]}
=======
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"bucketCfTemplates": {"Ref" : "bucketCfTemplates"},
					"vpcId": { "Fn::GetAtt" : [ "baseNetwork", "Outputs.vpcId" ] }
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/securitygroups.json"]]}
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
			},
			"DependsOn" : "baseSecurity"
		},

		"vpcEndPoints":{
			"Type":"AWS::CloudFormation::Stack",
<<<<<<< HEAD
=======
			"Condition" : "createVpcStack",
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
			"Properties" :{
				"Parameters" :{
					"tagStack": {"Ref" : "tagStack"},
					"tagProject": {"Ref" : "tagProject"},
					"tagGroup": {"Ref" : "tagGroup"},
<<<<<<< HEAD
					"tagCostCenter": {"Ref" : "tagCostCenter"},
=======
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"vpcId": { "Fn::GetAtt" : [ "baseNetwork", "Outputs.vpcId" ] },
					"internalRouteTableId": { "Fn::GetAtt" : [ "baseSecurity", "Outputs.internalRouteTableId" ] },
					"publicRouteTableId": { "Fn::GetAtt" : [ "baseSecurity", "Outputs.publicRouteTableId" ] },
					"bucketResources": {"Ref" : "bucketResources"}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/vpc-endpoints.json"]]}
			},
			"DependsOn" : "baseSecurity"
<<<<<<< HEAD
		}
	},
	"Outputs" : {
		"vpcId" : {
      "Description" : "The ID of the VPC created",
      "Value" : { "Fn::GetAtt" : [ "baseNetwork", "Outputs.vpcId" ] }
    }
	}
=======
		},

		"iamRoles":{
			"Type":"AWS::CloudFormation::Stack",
			"Condition" : "createVpcStack",
			"Properties" :{
				"Parameters" :{
					"tagStack": {"Ref" : "tagStack"},
					"tagProject": {"Ref" : "tagProject"},
					"tagGroup": {"Ref" : "tagGroup"},
					"tagEnvironment": {"Ref" : "tagEnvironment"},
					"tagKeepAlive": {"Ref" : "tagKeepAlive"},
					"tagOwner": {"Ref" : "tagOwner"},
					"bucketResources": {"Ref" : "bucketResources"},
					"lambdaCustomResourceGeneratorArn": { "Fn::GetAtt": [ "crossStackInfoPreliminariesStack", "lambdaCustomResourceGeneratorArn" ] },
					"iamRoleFlamenco": {"Ref" : "iamRoleFlamenco"},
					"iamRoleWebServer": {"Ref" : "iamRoleWebServer"}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/iam-setup.json"]]}
			}
		}
	},
	"Outputs" : {}
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
}
