{
	"AWSTemplateFormatVersion" : "2010-09-09",
	"Description" : "Creates all required Security Groups",
	"Parameters" : {
		"tagStack":{
	      "Type": "String",
	      "Description":"tag - stack name"
	  },
	  "tagProject":{
	    "Type": "String",
	    "Description":"Tag - Project name"
	  },
	  "tagGroup":{
	    "Type": "String",
	    "Description":"Tag - Group name"
	  },
		"tagEnvironment":{
	    "Type": "String",
	    "Description":"environment tag"
	  },
	  "tagKeepAlive":{
	    "Type": "String",
	    "Description":"Tag - Keep Alive tag"
	  },
	  "tagOwner":{
	  	"Type": "String",
	    "Description":"Tag - product owner"
	  },
		"bucketCfTemplates":{
			"Type":"String",
			"Description": "The name of the S3 bucket that holds the cloudformation templates used in nested stacks"
		},
	  "vpcId":{
	  	"Type":"AWS::EC2::VPC::Id",
	  	"Description":"The ID of the VPC the subnets shall be provisioned in."
	  }
	},
	"Mappings":{},
	"Resources" : {
		"flamencoSecurityGroup":{
			"Type" : "AWS::EC2::SecurityGroup",
			"Properties":{
				"GroupDescription" : "The security group that governs the flamenco instances",
				"Tags" :  [{
					"Key":"stack",
					"Value": {"Ref": "tagStack"}
					},{
	        "Key":"Name",
	        "Value":{"Fn::Join":["-",[{"Ref": "tagStack"},"flamencoSecurityGroup"]]}
	        },{
					"Key":"project",
	        "Value":{"Ref": "tagProject"}
					},{
					"Key":"group",
	        "Value":{"Ref": "tagGroup"}
					},{
					"Key":"environment",
					"Value":{"Ref": "tagEnvironment"}
					},{
					"Key":"keep-alive",
					"Value":{"Ref": "tagKeepAlive"}
					},{
					"Key":"owner",
					"Value":{"Ref": "tagOwner"}
					}
				],
				"VpcId" : {"Ref":"vpcId"}
			}
		},

		"webServerSecurityGroup":{
			"Type" : "AWS::EC2::SecurityGroup",
			"Properties":{
				"GroupDescription" : "The security group that governs the web server",
				"Tags" :  [{
					"Key":"stack",
					"Value": {"Ref": "tagStack"}
					},{
	        "Key":"Name",
	        "Value":{"Fn::Join":["-",[{"Ref": "tagStack"},"webServerSecurityGroup"]]}
	        },{
					"Key":"project",
	        "Value":{"Ref": "tagProject"}
					},{
					"Key":"group",
	        "Value":{"Ref": "tagGroup"}
					},{
					"Key":"environment",
					"Value":{"Ref": "tagEnvironment"}
					},{
					"Key":"keep-alive",
					"Value":{"Ref": "tagKeepAlive"}
					},{
					"Key":"owner",
					"Value":{"Ref": "tagOwner"}
					}
				],
				"VpcId" : {"Ref":"vpcId"}
			}
		},

		"sgIngressRules": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "tagStack": {"Ref": "tagStack"},
          "flamencoSecurityGroup":{"Ref":"flamencoSecurityGroup"},
					"webServerSecurityGroup":{"Ref":"webServerSecurityGroup"}
        },
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/securitygroups-ingressrules.json"]]}
      },
			"DependsOn":["flamencoSecurityGroup", "webServerSecurityGroup"],
      "Metadata":{
				"Comment" : "creates ingress rules for the security groups"
			}
    },

	  "sgEgressRules": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "Parameters": {
          "tagStack": {"Ref": "tagStack"},
          "flamencoSecurityGroup":{"Ref":"flamencoSecurityGroup"},
					"webServerSecurityGroup":{"Ref":"webServerSecurityGroup"}
        },
        "TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "bucketCfTemplates"}, "/vpc/securitygroups-egressrules.json"]]}
      },
			"DependsOn":["flamencoSecurityGroup", "webServerSecurityGroup"],
      "Metadata":{
				"Comment" : "creates egress rules for the security groups"
			}
    }
	},
	"Outputs" : {
		"flamencoSecurityGroupId":{
			"Description" : "The ID of the flamenco security group",
    	"Value" : {"Ref" : "flamencoSecurityGroup"}
		},
		"webServerSecurityGroupId":{
			"Description" : "The ID of the web server security group",
    	"Value" : {"Ref" : "webServerSecurityGroup"}
		}
	}
}
