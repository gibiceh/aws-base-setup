{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Create autoscaling EC2 groups to host jumpbox",

  "Parameters" : {
    "stackNameTag":{
	    "Type": "String",
	    "Description":"tag - stack name"
	  },
	  "projectTag":{
	    "Type": "String",
	    "Description":"tag - project name"
	  },
	  "groupTag":{
	    "Type": "String",
	    "Description":"tag - group name"
	  },
	  "costCenterTag":{
	    "Type": "String",
	    "Description":"tag - cost center"
	  },
		"environmentTag":{
	    "Type": "String",
	    "Description":"tag - environment"
	  },
	  "keepAliveTag":{
	    "Type": "String",
	    "Description":"tag - keep alive tag"
	  },
	  "ownerTag":{
	    "Type": "String",
	    "Description":"tag - product owner"
	  },
    "instanceTypeJumpBox":{
      "Description" : "ec2 instance type for the jumpbox asg",
      "Type" : "String"
    },
    "keyName" : {
      "Description" : "The EC2 Key Pair for the instances",
      "Type" : "String",
      "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
    },
    "snsEc2Topic":{
      "Type": "String",
      "Description":"arn for the sns topic for asg notifications."
    },
    "publicSubnetId":{
      "Description" : "The ID of the public subnet.",
      "Type": "String"
    },
    "jumpBoxSecurityGroup":{
      "Description" : "Security Group for jumpbox in public subnet",
      "Type":"AWS::EC2::SecurityGroup::Id"
    },
    "jumpBoxInstanceProfile":{
      "Type": "String",
      "Description":"instance profile."
    },
    "eipAllocationIdRdGateway":{
      "Type": "String",
      "Description": "EIP allocation ID for JumpBox"
    },
    "cfTemplateBucketName":{
      "Type":"String",
      "Description": "The name of the S3 bucket that holds the cloudformation templates used in nested stacks"
    },
    "resourcesBucketName" : {
      "Description" : "The name of the bucket that contains your packaged source",
      "Type" : "String"
    },
    "latestAmiFunctionArn" : {
      "Description" : "The arn for the lambda function that looks up the latest Amazon Linux AMI",
      "Type" : "String"
    },
    "doNotCreate" : {
      "Description" : "If doNotCreateStack condition is present (\"Condition\" : \"doNotCreateStack\") in resource definition, then the resource is not created",
      "Default" : "true",
      "Type" : "String"
    }
  },

  "Conditions" : {
    "doNotCreateStack" : {"Fn::Equals" : [{"Ref" : "doNotCreate"}, "false"]}
  },

  "Mappings" : {
    "AWSInstanceType2Arch" : {
      "t1.micro"    : { "Arch" : "PV64"   },
      "t2.micro"    : { "Arch" : "HVM64"  },
      "t2.small"    : { "Arch" : "HVM64"  },
      "t2.medium"   : { "Arch" : "HVM64"  },
      "m1.small"    : { "Arch" : "PV64"   },
      "m1.medium"   : { "Arch" : "PV64"   },
      "m1.large"    : { "Arch" : "PV64"   },
      "m1.xlarge"   : { "Arch" : "PV64"   },
      "m2.xlarge"   : { "Arch" : "PV64"   },
      "m2.2xlarge"  : { "Arch" : "PV64"   },
      "m2.4xlarge"  : { "Arch" : "PV64"   },
      "m3.medium"   : { "Arch" : "HVM64"  },
      "m3.large"    : { "Arch" : "HVM64"  },
      "m3.xlarge"   : { "Arch" : "HVM64"  },
      "m3.2xlarge"  : { "Arch" : "HVM64"  },
      "c1.medium"   : { "Arch" : "PV64"   },
      "c1.xlarge"   : { "Arch" : "PV64"   },
      "c3.large"    : { "Arch" : "HVM64"  },
      "c3.xlarge"   : { "Arch" : "HVM64"  },
      "c3.2xlarge"  : { "Arch" : "HVM64"  },
      "c3.4xlarge"  : { "Arch" : "HVM64"  },
      "c3.8xlarge"  : { "Arch" : "HVM64"  },
      "c4.large"    : { "Arch" : "HVM64"  },
      "c4.xlarge"   : { "Arch" : "HVM64"  },
      "c4.2xlarge"  : { "Arch" : "HVM64"  },
      "c4.4xlarge"  : { "Arch" : "HVM64"  },
      "c4.8xlarge"  : { "Arch" : "HVM64"  },
      "g2.2xlarge"  : { "Arch" : "HVMG2"  },
      "r3.large"    : { "Arch" : "HVM64"  },
      "r3.xlarge"   : { "Arch" : "HVM64"  },
      "r3.2xlarge"  : { "Arch" : "HVM64"  },
      "r3.4xlarge"  : { "Arch" : "HVM64"  },
      "r3.8xlarge"  : { "Arch" : "HVM64"  },
      "i2.xlarge"   : { "Arch" : "HVM64"  },
      "i2.2xlarge"  : { "Arch" : "HVM64"  },
      "i2.4xlarge"  : { "Arch" : "HVM64"  },
      "i2.8xlarge"  : { "Arch" : "HVM64"  },
      "d2.xlarge"   : { "Arch" : "HVM64"  },
      "d2.2xlarge"  : { "Arch" : "HVM64"  },
      "d2.4xlarge"  : { "Arch" : "HVM64"  },
      "d2.8xlarge"  : { "Arch" : "HVM64"  },
      "hi1.4xlarge" : { "Arch" : "HVM64"  },
      "hs1.8xlarge" : { "Arch" : "HVM64"  },
      "cr1.8xlarge" : { "Arch" : "HVM64"  },
      "cc2.8xlarge" : { "Arch" : "HVM64"  }
    }
  },

  "Resources" : {
    "publicEc2JumpBox":{
		  "Type":"AWS::CloudFormation::Stack",
		  "Properties" :{
		    "Parameters" :{
					"stackNameTag": {"Ref" : "stackNameTag"},
					"projectTag": {"Ref" : "projectTag"},
					"groupTag": {"Ref" : "groupTag"},
					"costCenterTag": {"Ref" : "costCenterTag"},
					"environmentTag": {"Ref" : "environmentTag"},
					"keepAliveTag": {"Ref" : "keepAliveTag"},
					"ownerTag": {"Ref" : "ownerTag"},
					"instanceTypeJumpBox": {"Ref" : "instanceTypeJumpBox"},
		      "keyName": {"Ref" : "keyName"},
		      "snsEc2Topic": {"Ref" : "snsEc2Topic"},
		      "publicSubnetId": {"Ref" : "publicSubnetId"},
		    	"jumpBoxSecurityGroup": {"Ref" : "jumpBoxSecurityGroup"},
					"jumpBoxInstanceProfile": {"Ref" : "jumpBoxInstanceProfile"},
					"eipAllocationIdRdGateway": {"Ref" : "eipAllocationIdRdGateway"},
					"resourcesBucketName": {"Ref" : "resourcesBucketName"},
          "architecture": { "Fn::FindInMap" : [ "AWSInstanceType2Arch", { "Ref" : "instanceTypeJumpBox" }, "Arch" ] },
          "latestAmiFunctionArn": { "Ref" : "latestAmiFunctionArn" }
	      },
	      "TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "cfTemplateBucketName"}, "/vpc/public-instances-jumpbox.json"]]}
		  }
		}
  },

  "Outputs" : {
  }
}
