{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Provision sns alarm notification topic, optional cloudtrail for the account, lambda functions for latest ami lookup",
  "Parameters": {
    "costCenterTag":{
      "Type": "String",
      "Description":"tag - cost center"
    },
    "environmentTag":{
      "Type": "String",
      "Description":"tag - environment",
      "AllowedValues" : ["sb", "test", "dev", "mergeddev", "qa", "prod"]
    },
    "groupTag":{
      "Type": "String",
      "Description":"tag - group name"
    },
    "keepAliveTag":{
      "Type": "String",
      "Description":"tag - keep alive tag",
      "AllowedValues" : ["true", "false"]
    },
    "ownerTag":{
      "Type": "String",
      "Description":"tag - product owner"
    },
    "projectTag":{
      "Type": "String",
      "Description":"tag - project name"
    },
    "stackNameTag":{
	    "Type": "String",
	    "Description":"tag - stack name"
	  },
    "billingAlarmThreshold" : {
      "Description" : "Billing alarm threshold in US dollars",
      "Type" : "String"
    },
    "cloudTrailCreate": {
      "Description": "Determines if cloudtrail is setup or not",
      "Type": "String",
      "AllowedValues" : ["true", "false"]
    },
    "cloudTrailS3BucketName": {
      "Description": "Name for the bucket to contain cloudtrail logs",
      "Type": "String"
    },
    "cfTemplateBucketName": {
      "Description": "The name of the S3 bucket that holds the cloudformation templates used in nested stacks",
      "Type": "String"
    },
    "resourcesBucketName":{
      "Type":"String",
      "Description": "The name of the S3 bucket that holds project resource files"
    },
    "snsTopic": {
      "Description": "Name for the sns topic receiving alarm notifications",
      "Type": "String"
    },
    "snsTopicEmailSubscription": {
      "Description": "email address to subscribe to sns topic for {\"Ref\":\"snsTopicName\"} notifications",
      "Type": "String"
    },
    "doNotCreate" : {
      "Description" : "If doNotCreateStack condition is present (\"Condition\" : \"doNotCreateStack\") in resource definition, then the resource is not created (CANNOT be used to remove already created stack resources)",
      "Default" : "true",
      "Type" : "String"
    }
  },

  "Conditions" : {
    "doNotCreateStack" : {"Fn::Equals" : [{"Ref" : "doNotCreate"}, "false"]},
    "createCloudTrail" : {"Fn::Equals" : [{"Ref" : "cloudTrailCreate"}, "true"]}
  },

  "Resources": {
    "cloudTrailSetup": {
			"Type":"AWS::CloudFormation::Stack",
      "Metadata":{
        "Comment" : "Provision cloudtrail for the account (with s3 bucket) and set up cloudwatch billing alarms"
      },
      "Condition" : "createCloudTrail",
			"Properties" :{
				"Parameters" :{
					"costCenterTag": {"Ref" : "costCenterTag"},
          "environmentTag": {"Ref" : "environmentTag"},
          "groupTag": {"Ref" : "groupTag"},
					"keepAliveTag": {"Ref" : "keepAliveTag"},
					"ownerTag": {"Ref" : "ownerTag"},
          "projectTag": {"Ref" : "projectTag"},
          "stackNameTag": {"Ref" : "stackNameTag"},
          "billingAlarmThreshold": {"Ref" : "billingAlarmThreshold"},
          "cloudTrailS3BucketName": {"Ref" : "cloudTrailS3BucketName"},
          "snsAlarmTopicArn": { "Fn::GetAtt" : [ "setupSns", "Outputs.snsTopicArn" ] }
				},
        "TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "cfTemplateBucketName"}, "/preliminaries/cloudtrail.json"]]}
		  },
      "DependsOn" : "setupSns"
    },

    "iamSetup": {
			"Type":"AWS::CloudFormation::Stack",
      "Metadata": {
        "Comment":"Provision iam groups, policies, roles, and users.",
        "Comment2":"Needed by lambda."
      },
			"Properties" :{
				"Parameters" :{
          "costCenterTag": {"Ref" : "costCenterTag"},
          "environmentTag": {"Ref" : "environmentTag"},
          "groupTag": {"Ref" : "groupTag"},
					"keepAliveTag": {"Ref" : "keepAliveTag"},
					"ownerTag": {"Ref" : "ownerTag"},
          "projectTag": {"Ref" : "projectTag"},
          "stackNameTag": {"Ref" : "stackNameTag"}
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "cfTemplateBucketName"}, "/preliminaries/iam-setup.json"]]}
      }
    },

    "lambdaFunctions":{
			"Type":"AWS::CloudFormation::Stack",
      "Metadata":{
        "Comment":"Create lambda function needed for latest amazon ami info lookup"
      },
			"Properties" :{
				"Parameters" :{
          "costCenterTag": {"Ref" : "costCenterTag"},
          "environmentTag": {"Ref" : "environmentTag"},
          "groupTag": {"Ref" : "groupTag"},
					"keepAliveTag": {"Ref" : "keepAliveTag"},
					"ownerTag": {"Ref" : "ownerTag"},
          "projectTag": {"Ref" : "projectTag"},
          "stackNameTag": {"Ref" : "stackNameTag"},
					"resourcesBucketName": {"Ref" : "resourcesBucketName"},
					"latestAmazonAmiInfoExecutionRoleArn": { "Fn::GetAtt" : [ "iamSetup", "Outputs.latestAmazonAmiInfoExecutionRoleArn" ] }
				},
				"TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "cfTemplateBucketName"}, "/preliminaries/lambda-functions.json"]]}
			},
			"DependsOn" : "iamSetup"
		},

    "setupSns" : {
      "Type":"AWS::CloudFormation::Stack",
      "Metadata":{
        "Comment":"Provision SNS topic for alarm/monitoring notifications."
      },
			"Properties" :{
				"Parameters" :{
          "costCenterTag": {"Ref" : "costCenterTag"},
          "environmentTag": {"Ref" : "environmentTag"},
          "groupTag": {"Ref" : "groupTag"},
					"keepAliveTag": {"Ref" : "keepAliveTag"},
					"ownerTag": {"Ref" : "ownerTag"},
          "projectTag": {"Ref" : "projectTag"},
          "stackNameTag": {"Ref" : "stackNameTag"},
          "snsTopic" : {"Ref" : "snsTopic"},
          "snsTopicEmailSubscription" : {"Ref" : "snsTopicEmailSubscription"}
				},
        "TemplateURL" : {"Fn::Join":["",["https://s3.amazonaws.com/", {"Ref": "cfTemplateBucketName"}, "/preliminaries/setup-sns.json"]]}
		  }
    }
  },

  "Outputs" : {
    "amiInfoFunctionArn":{
			"Description" : "The arn of the latestAmazonAmiInfoLambdaFunction function",
    	"Value" : { "Fn::GetAtt" : ["lambdaFunctions", "Outputs.amiInfoFunctionArn"] }
		},
    "snsTopicArn":{
			"Description" : "The arn of the SNS Topic for monitoring/alarm notifications",
    	"Value" : { "Fn::GetAtt" : ["setupSns", "Outputs.snsTopicArn"] }
		}
  }
}
