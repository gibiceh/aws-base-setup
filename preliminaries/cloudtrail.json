{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Provision cloudtrail for the account (with s3 bucket) and set up cloudwatch billing alarms",
  "Parameters": {
    "tagCostCenter":{
      "Type": "String",
      "Description":"tag - cost center"
    },
    "tagEnvironment":{
      "Type": "String",
      "Description":"tag - environment",
      "AllowedValues" : ["sb", "test", "dev", "mergeddev", "qa", "prod"]
    },
    "tagGroup":{
      "Type": "String",
      "Description":"tag - group name"
    },
    "tagKeepAlive":{
      "Type": "String",
      "Description":"tag - keep alive tag",
      "AllowedValues" : ["true", "false"]
    },
    "tagOwner":{
      "Type": "String",
      "Description":"tag - product owner"
    },
    "tagProject":{
      "Type": "String",
      "Description":"tag - project name"
    },
    "tagStack":{
	    "Type": "String",
	    "Description":"tag - stack name"
	  },
    "alarmBillingThreshold" : {
      "Description" : "Billing alarm threshold in US dollars",
      "Type" : "String"
    },
    "bucketCloudTrail": {
      "Description": "Name for the bucket to contain cloudtrail logs",
      "Type": "String"
    },
    "snsAlarmTopicArn": {
      "Description": "Arn for the sns topic receiving billing alarm notifications",
      "Type": "String"
    }
  },
  "Resources": {
    "cloudTrailBucket": {
      "Type": "AWS::S3::Bucket",
      "Metadata":{
        "Comment" : "Provision s3 bucket to contain the cloudtrail logs generated by the aws account.",
        "Comment2" : "This s3 bucket is retained after stack deletion."
      },
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketName" : {"Ref" : "bucketCloudTrail"},
        "Tags":[
          {
            "Key":"cost-center",
            "Value":{"Ref": "tagCostCenter"}
          },
          {
            "Key":"environment",
            "Value":{"Ref": "tagEnvironment"}
	        },
          {
            "Key":"group",
            "Value":{"Ref": "tagGroup"}
          },
          {
		        "Key":"keep-alive",
		        "Value":{"Ref": "tagKeepAlive"}
		      },
          {
		        "Key":"owner",
		        "Value":{"Ref": "tagOwner"}
		      },
          {
            "Key":"project",
            "Value":{"Ref": "tagProject"}
          },
          {
            "Key":"stack",
            "Value": {"Ref": "tagStack"}
          }
        ]
      }
    },

    "cloudTrailBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Metadata":{
        "Comment": "Bucket policy that allows cloudtrail to write to the cloudtrail s3 bucket"
      },
      "Properties": {
        "Bucket": {"Ref": "bucketCloudTrail"},
        "PolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:GetBucketAcl",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:s3:::",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Ref": "bucketCloudTrail"
                          }
                        ]
                      ]
                    }
                  ]
                ]
              }
            },
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Fn::Join": [
                          "",
                          [
                            {
                              "Ref": "bucketCloudTrail"
                            }
                          ]
                        ]
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    },

    "cloudTrailSetup": {
      "Type": "AWS::CloudTrail::Trail",
      "Metadata":{
        "Comment":"Provision cloudtrail for the aws account.",
        "Comment2":"Cloudtrail retained after stack deletion."
      },
      "DeletionPolicy": "Retain",
      "Properties": {
        "IncludeGlobalServiceEvents": true,
        "IsLogging": true,
        "S3BucketName": {
          "Ref": "bucketCloudTrail"
        },
        "Tags":[
          {
            "Key":"cost-center",
            "Value":{"Ref": "tagCostCenter"}
          },
          {
            "Key":"environment",
            "Value":{"Ref": "tagEnvironment"}
	        },
          {
            "Key":"group",
            "Value":{"Ref": "tagGroup"}
          },
          {
		        "Key":"keep-alive",
		        "Value":{"Ref": "tagKeepAlive"}
		      },
          {
		        "Key":"owner",
		        "Value":{"Ref": "tagOwner"}
		      },
          {
            "Key":"project",
            "Value":{"Ref": "tagProject"}
          },
          {
            "Key":"stack",
            "Value": {"Ref": "tagStack"}
          }
        ]
      },
      "DependsOn" : "cloudTrailBucket"
    },

    "spendingAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Metadata":{
        "Comment" : "Provision cloudwatch alarm to trigger when the account has surpassed defined billing threshold"
      },
      "Properties": {
        "AlarmDescription": { "Fn::Join": ["", [
          "Alarm if AWS spending is over $",
          { "Ref": "alarmBillingThreshold" }
          ]]
        },
        "Namespace": "AWS/Billing",
        "MetricName": "EstimatedCharges",
        "Dimensions": [
          {
          "Name": "Currency",
          "Value" : "USD"
          }
        ],
        "Statistic": "Maximum",
        "Period": "21600",
        "EvaluationPeriods": "1",
        "Threshold": { "Ref": "alarmBillingThreshold" },
        "ComparisonOperator": "GreaterThanThreshold",
        "AlarmActions": [
          {
          "Ref": "snsAlarmTopicArn"
          }
        ],
        "InsufficientDataActions": [
          {
          "Ref": "snsAlarmTopicArn"
          }
        ]
      }
    }
  }
}
