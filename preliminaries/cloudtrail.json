{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Provision cloudtrail for the account (with s3 bucket) and sets up cloudwatch billing alarms",
  "Parameters": {
    "stackNameTag":{
	      "Type": "String",
	      "Description":"tag - stack name"
	  },
    "projectTag":{
      "Type": "String",
<<<<<<< HEAD
      "Description":"tag - project name"
    },
    "groupTag":{
      "Type": "String",
      "Description":"tag - group name"
    },
    "costCenterTag":{
      "Type": "String",
      "Description":"tag - cost center"
    },
    "environmentTag":{
      "Type": "String",
      "Description":"tag - environment"
    },
    "keepAliveTag":{
      "Type": "String",
      "Description":"tag - keep alive tag"
    },
    "ownerTag":{
      "Type": "String",
      "Description":"tag - product owner"
=======
      "Description":"Tag - Project name"
    },
    "groupTag":{
      "Type": "String",
      "Description":"Tag - Group name"
    },
    "environmentTag":{
      "Type": "String",
      "Description":"Tag - Environment"
    },
    "keepAliveTag":{
      "Type": "String",
      "Description":"Tag - Keep Alive tag"
    },
    "ownerTag":{
      "Type": "String",
      "Description":"Tag - product owner"
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
    },
    "billingAlarmThreshold" : {
      "Description" : "Billing alarm threshold in US dollars",
      "Type" : "String"
    },
<<<<<<< HEAD
    "cloudTrailS3BucketName": {
=======
    "cloudTrailS3Bucket": {
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
      "Description": "Name for the bucket to contain cloudtrail logs",
      "Type": "String"
    },
    "snsAlarmTopicArn": {
      "Description": "Arn for the sns topic receiving billing alarm notifications",
      "Type": "String"
    }
  },
  "Resources": {
    "spendingAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmDescription": { "Fn::Join": ["", [
          "Alarm if AWS spending is over $",
          { "Ref": "billingAlarmThreshold" }
          ]]
        },
        "Namespace": "AWS/Billing",
        "MetricName": "EstimatedCharges",
        "Dimensions": [{
          "Name": "Currency",
          "Value" : "USD"
        }],
        "Statistic": "Maximum",
        "Period": "21600",
        "EvaluationPeriods": "1",
        "Threshold": { "Ref": "billingAlarmThreshold" },
        "ComparisonOperator": "GreaterThanThreshold",
        "AlarmActions": [{
          "Ref": "snsAlarmTopicArn"
        }],
        "InsufficientDataActions": [{
          "Ref": "snsAlarmTopicArn"
        }]
      }
    },

    "cloudTrailBucket": {
      "Type": "AWS::S3::Bucket",
<<<<<<< HEAD
      "DeletionPolicy": "Retain",
      "Properties": {
        "BucketName" : {"Ref" : "cloudTrailS3BucketName"},
=======
      "Properties": {
        "BucketName" : {"Ref" : "cloudTrailS3Bucket"},
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
        "Tags":[{
                "Key":"stack",
                "Value": {"Ref": "stackNameTag"}
            },{
                "Key":"project",
                "Value":{"Ref": "projectTag"}
            },{
                "Key":"group",
                "Value":{"Ref": "groupTag"}
            },{
<<<<<<< HEAD
                "Key":"cost-center",
                "Value":{"Ref": "costCenterTag"}
            },{
=======
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
		            "Key":"environment",
		            "Value":{"Ref": "environmentTag"}
		        },{
		            "Key":"keep-alive",
		            "Value":{"Ref": "keepAliveTag"}
		        },{
		            "Key":"owner",
		            "Value":{"Ref": "ownerTag"}
		        }
        ]
      }
    },
    "cloudTrailBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
<<<<<<< HEAD
          "Ref": "cloudTrailS3BucketName"
=======
          "Ref": "cloudTrailS3Bucket"
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:GetBucketAcl",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:s3:::",
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
<<<<<<< HEAD
                            "Ref": "cloudTrailS3BucketName"
=======
                            "Ref": "cloudTrailS3Bucket"
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
                          }
                        ]
                      ]
                    }
                  ]
                ]
              }
            },
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Fn::Join": [
                          "",
                          [
                            {
<<<<<<< HEAD
                              "Ref": "cloudTrailS3BucketName"
=======
                              "Ref": "cloudTrailS3Bucket"
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
                            }
                          ]
                        ]
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    "cloudTrailSetup": {
      "Type": "AWS::CloudTrail::Trail",
      "DeletionPolicy": "Retain",
      "Properties": {
        "IncludeGlobalServiceEvents": true,
        "IsLogging": true,
        "S3BucketName": {
<<<<<<< HEAD
          "Ref": "cloudTrailS3BucketName"
=======
          "Ref": "cloudTrailS3Bucket"
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
        },
        "Tags":[{
                "Key":"stack",
                "Value": {"Ref": "stackNameTag"}
            },{
                "Key":"project",
                "Value":{"Ref": "projectTag"}
            },{
                "Key":"group",
                "Value":{"Ref": "groupTag"}
            },{
<<<<<<< HEAD
                "Key":"cost-center",
                "Value":{"Ref": "costCenterTag"}
            },{
=======
>>>>>>> 9b7d460039404db119ef7086991afccd58f2ce73
		            "Key":"environment",
		            "Value":{"Ref": "environmentTag"}
		        },{
		            "Key":"keep-alive",
		            "Value":{"Ref": "keepAliveTag"}
		        },{
		            "Key":"owner",
		            "Value":{"Ref": "ownerTag"}
		        }
        ]
      },
      "DependsOn" : "cloudTrailBucket"
    }

  }
}
